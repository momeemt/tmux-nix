# tmux-nix

このプロジェクトは、tmuxの各種設定やプラグインを`.tmux.conf`レスに管理することを目指したNixOSモジュールです。
nixpkgsやhome-managerが提供するNixOSモジュールでは、Nix式で管理できる範囲が`prefix`などのいくつかの基本的な設定に留まり、高度な設定に関しては自前で`.tmux.conf`を記述して文字列として渡す必要があります。
先行研究としてはNeovimの設定をNix式で行うための[nixvim](https://github.com/nix-community/nixvim)などが存在していますが、tmuxに関しては実用的なモジュールは存在していないようです。

## 使用言語について

私とCopilotとのやり取りは日本語で行いますが、ドキュメント（`README.md`や`doc`配下のMarkdownファイル）に関しては英語で記述してください。
また、ソースコードのコメントや、Pull Requestの説明文なども同様に英語で記述してください。

## 開発環境

NixOS 24.11で開発を行います。
`flake.nix`に環境をセットアップするための設定が含まれており、`direnv`を利用しているため`direnv allow`を実行すれば開発環境に入ることができます。
また、`nix fmt`を実行することでプロジェクト内に含まれるファイルについて自動整形を行うことができます。もしここでフォーマット対象外のファイルが存在すると警告された場合には、[flake-parts](https://flake.parts/)の[treefmt-nix](https://flake.parts/options/treefmt-nix.html)が対応するファイル形式であればそれを追加し、そうでなければ無視する設定を加えてください。

## copilot-instructions.mdへの追記

チャット内でのやり取りのうち、長期的にプロジェクトに影響を与えるようなものについては、`.github/copilot-instructions.md`に追記してください。追記した場合には必ず、どのような内容を追記したのかをチャットで説明するようにしてください。そこでもし不要な内容があれば、私が指摘しますので、指摘された場合にはその内容を削除してください。

## コーディングガイドライン

- `nixpkgs`の`lib`を利用する場合には、`with lib;`を使わずに関数を明示的に呼び出してください。これによりスコープが狭くなり、意図しない変数の上書きなどを防ぐことができます。
- tmux-nixはできるだけ宣言的にtmuxの設定を行うことを目指しています。したがって、手続き的な記述があれば宣言的な記述に書き換えるようにしてください。どのように書き換えるかはいくつかの方法を考え、チャット内で提示して、開発者と相談するようにしてください。
- Nixの属性を記述する際は、可能な限りネストした形式を使用してください。例えば、`foo.bar = 1; foo.baz = 2;`のような形式ではなく、`foo = { bar = 1; baz = 2; };`のように記述してください。

## モジュール構造

tmux-nixは`programs.tmux-nix`として定義され、home-managerの標準的な構造に従います。これにより、他のhome-managerプログラムと一貫性のある設定方法を提供します。

### 主要オプション

- `programs.tmux-nix.enable`: モジュールの有効化
- `programs.tmux-nix.out`: 設定ファイルの出力パス（デフォルト: `~/.tmux.conf`）
- `programs.tmux-nix.package`: 使用するtmuxパッケージ
- `programs.tmux-nix.prefix`: プレフィックスキー
- `programs.tmux-nix.keymaps.*`: キーマップ設定（pane移動、リサイズ、ウィンドウ分割、リロード）
- `programs.tmux-nix.defaultTerminal`: ターミナル設定
- `programs.tmux-nix.terminalOverrides`: ターミナル機能上書き（TrueColor対応など）
- `programs.tmux-nix.plugins.*`: プラグイン設定

### パス処理

設定ファイルの出力パスでチルダ（`~`）を使用する場合、home-managerの`home.file`では相対パス（`~/.tmux.conf` → `.tmux.conf`）として処理し、tmuxのreloadコマンドでは絶対パス（`/home/user/.tmux.conf`）として解決する必要があります。

## テスト

- `flake.nix`にはNixOSモジュールのテストが含まれています。これを実行することでNixOSモジュールのテストを行うことができます。
- テストは`nix flake check`を実行することで行うことができます。もし新しいファイルを追加した際には、事前に`git add .`を実行してからでないとNixがファイルを認識しません。
- 全てのPRはSquash mergeを行うため、コミット粒度に気を配る必要はありません。
- NixOSモジュールのテストはKVMを立ち上げて実際にNixOSを起動し、tmuxが正しく動作するかどうかを確認するものです。したがって、複数のVMが立ち上がるようなテストは避け、なるべく1つのVMで完結するようにしてください。
- テストを行う前には`nix fmt`を実行してからテストを行ってください。さもないと、フォーマットに対するテストが失敗してしまい二度手間になります。
- 生成される`.tmux.conf`の内容を確認することでテストを行ってください。その際には`grep -q '^${line}$'`を利用してください。
- テストはできるだけ詳細に行ってください。特に、複数の組み合わせが考えられる場合にはできるだけ多くのパターンをテストできるように設定項目を分けてください。
- テスト設定は`tests/`ディレクトリ以下に配置してください。
  - 入力設定（NixOSモジュールのオプション設定）は`tests/inputs/`ディレクトリ以下に配置します。
    - ルートオプションのテストは`tests/inputs/default.nix`に記述します。
    - プラグインオプションのテストは`tests/inputs/plugins/`配下にプラグイン名を冠したNixファイル（例: `tests/inputs/plugins/cpu.nix`）として記述します。
  - 出力検証（生成される`.tmux.conf`の内容を確認するスクリプト）は`tests/outputs/`ディレクトリ以下に配置します。
  - テストヘルパー関数（`escape`や`check`など）は`tests/lib.nix`に記述します。
  - 各テスト入力ファイルは`flake.nix`の`checks.tmux-nix-test.nodes.machine.home-manager.users.alice.imports`に追記して読み込むようにしてください。
  - `testScript`は`tests/outputs/`以下のファイルをインポートして使用します。

## ドキュメント

- 提供するオプションの意味やデフォルト値、型などを記載し、できるだけサンプルコードをつけるようにしてください。
- tmuxのオプションそのものについてはtmuxのドキュメントを参照させることにして、tmuxを知らなくてもtmux-nixのドキュメントを読めばtmuxを利用できることを目指してください。
- 冗長な説明は避けるべきですが、一方でソースコードを読まないとわからないような説明は避けるべきです。
- READMEには詳細な説明を避け、doc配下に新しくファイルを作成して詳細な説明を行うようにしてください。READMEではそのファイルへのリンクを貼るようにしてください。
- プラグインのドキュメントでは、提供されるフォーマット文字列を明確に記載し、それぞれがどのような情報を表示するかを説明してください。
- オプションの型、デフォルト値、説明を構造化して記載し、ユーザーが設定を理解しやすくしてください。
- 実用的な使用例を複数パターン提供し、基本的な使用から高度なカスタマイズまでカバーしてください。
